<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>India Trip Map ‚Äî Admin (Edit & Export JSON)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  #app { display: grid; grid-template-columns: 1fr 320px; grid-template-rows: 56px 1fr; height: 100%; }
  header { grid-column: 1 / 3; display: flex; gap: 8px; align-items: center; padding: 8px 12px; border-bottom: 1px solid #eee; background: #fafafa; }
  header h1 { font-size: 15px; margin: 0 8px 0 0; font-weight: 600; color: #333; }
  select, input, button { height: 36px; border: 1px solid #ddd; border-radius: 8px; padding: 0 10px; font-size: 14px; }
  input[type="text"] { width: 360px; max-width: 60vw; }
  button { cursor: pointer; background: white; }
  .btn-primary { background: #111; color: #fff; border-color: #111; }
  #map { grid-column: 1 / 2; grid-row: 2 / 3; }
  aside { grid-column: 2 / 3; grid-row: 2 / 3; border-left: 1px solid #eee; display: flex; flex-direction: column; min-width: 280px; }
  .panel-head { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; display:flex; align-items:center; gap:8px; }
  .panel-head input { flex:1; }
  .list { overflow: auto; }
  .empty { color: #777; font-size: 13px; padding: 16px; }
  .place { padding: 10px 12px; border-bottom: 1px solid #f5f5f5; display:flex; gap:8px; align-items: center; font-size: 14px;}
  .place .emoji { width: 22px; text-align: center; }
  .place .meta { flex: 1; }
  .place .meta .name { font-weight: 600; color:#222; }
  .place .meta .notes { color:#666; font-size:12px; }
  .actions { display:flex; gap:6px; }
  .legend { margin-left: auto; display:flex; gap:10px; align-items:center; font-size: 14px; }
  .legend span { display:inline-flex; align-items:center; gap:4px; color:#333; }
  .legend .dot { width: 18px; text-align:center; }
  .toolrow { margin-left:auto; display:flex; gap:8px; }
  .capital-label {
    background: rgba(255,255,255,0.85);
    padding: 1px 6px;
    border: 1px solid #e7e7e7;
    border-radius: 10px;
    font-size: 11px;
    color: #111;
    pointer-events:none;
    white-space: nowrap;
  }
  .small { font-size: 12px; color:#666; }
</style>
</head>
<body>
<div id="app">
  <header>
    <h1>India Trip Map ‚Äî Admin</h1>
    <select id="statusSel" title="Category">
      <option value="visited">Visited üìç</option>
      <option value="lite">Visited (Lite) ‚úàÔ∏è</option>
      <option value="stayed">Stayed üè°</option>
    </select>
    <input id="placeInput" type="text" placeholder="Type a place (e.g., Hampi, Karnataka) and press Enter" />
    <button id="addBtn" class="btn-primary">Add</button>
    <div class="legend" title="Legend">
      <span><span class="dot">üìç</span>Visited</span>
      <span><span class="dot">‚úàÔ∏è</span>Visited (Lite)</span>
      <span><span class="dot">üè°</span>Stayed</span>
    </div>
    <div class="toolrow">
      <button id="exportJsonBtn" title="Download a data/places.json you can commit">Export JSON</button>
      <button id="exportFullBtn" title="Download admin.html for backup">Export Admin HTML</button>
    </div>
  </header>

  <div id="map"></div>

  <aside>
    <div class="panel-head">
      <input id="filterInput" type="text" placeholder="Filter list‚Ä¶" />
      <span class="small" id="count"></span>
    </div>
    <div class="list" id="list"></div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map', { minZoom:4, maxZoom:18 });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap & CARTO', subdomains:'abcd', maxZoom: 20
  }).addTo(map);
  const bounds = L.latLngBounds([6.5, 67.5],[37.5, 97.5]); map.fitBounds(bounds); map.setMaxBounds(bounds.pad(0.2));

  // Capitals
  const capitals = [
    {c:'Amaravati', lat:16.5101, lng:80.5160},{c:'Itanagar', lat:27.0844, lng:93.6053},{c:'Dispur', lat:26.1400, lng:91.7900},
    {c:'Patna', lat:25.5941, lng:85.1376},{c:'Raipur', lat:21.2514, lng:81.6296},{c:'Panaji', lat:15.4909, lng:73.8278},
    {c:'Gandhinagar', lat:23.2156, lng:72.6369},{c:'Chandigarh*', lat:30.7333, lng:76.7794},{c:'Shimla', lat:31.1048, lng:77.1734},
    {c:'Ranchi', lat:23.3441, lng:85.3096},{c:'Bengaluru', lat:12.9716, lng:77.5946},{c:'Thiruvananthapuram', lat:8.5241, lng:76.9366},
    {c:'Bhopal', lat:23.2599, lng:77.4126},{c:'Mumbai', lat:19.0760, lng:72.8777},{c:'Imphal', lat:24.8170, lng:93.9368},
    {c:'Shillong', lat:25.5788, lng:91.8933},{c:'Aizawl', lat:23.7271, lng:92.7176},{c:'Kohima', lat:25.6751, lng:94.1086},
    {c:'Bhubaneswar', lat:20.2961, lng:85.8245},{c:'Jaipur', lat:26.9124, lng:75.7873},{c:'Gangtok', lat:27.3389, lng:88.6065},
    {c:'Chennai', lat:13.0827, lng:80.2707},{c:'Hyderabad', lat:17.3850, lng:78.4867},{c:'Agartala', lat:23.8315, lng:91.2868},
    {c:'Lucknow', lat:26.8467, lng:80.9462},{c:'Dehradun', lat:30.3165, lng:78.0322},{c:'Kolkata', lat:22.5726, lng:88.3639},
    {c:'Port Blair', lat:11.6234, lng:92.7265},{c:'Chandigarh', lat:30.7333, lng:76.7794},{c:'Daman', lat:20.3974, lng:72.8328},
    {c:'New Delhi', lat:28.6139, lng:77.2090},{c:'Srinagar/Jammu', lat:34.0837, lng:74.7973},{c:'Leh', lat:34.1526, lng:77.5771},
    {c:'Kavaratti', lat:10.5667, lng:72.6167},{c:'Puducherry', lat:11.9139, lng:79.8145}
  ];
  capitals.forEach(k => L.marker([k.lat, k.lng], {
    icon: L.divIcon({ className:'capital-label', html:k.c, iconSize:[10,10], iconAnchor:[5,5] }),
    interactive:false
  }).addTo(map));

  // Store
  let places = [];
  const layerGroup = L.layerGroup().addTo(map);
  const STORAGE_KEY = 'admin_places_v1';
  const load = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(places));

  // State shading for admin (to preview)
  const stateShadeCache = new Map();
  async function fetchStateForPoint(lat,lng){
    const url = new URL('https://nominatim.openstreetmap.org/reverse');
    url.searchParams.set('lat', lat); url.searchParams.set('lon', lng);
    url.searchParams.set('format','json'); url.searchParams.set('zoom','10'); url.searchParams.set('addressdetails','1');
    const res = await fetch(url, { headers: { 'User-Agent':'India-Trip-Map/1.0' } });
    const data = await res.json();
    return data?.address?.state || null;
  }
  async function fetchStatePolygon(stateName){
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('q', `${stateName}, India`); url.searchParams.set('countrycodes','in');
    url.searchParams.set('format','json'); url.searchParams.set('limit','1'); url.searchParams.set('polygon_geojson','1');
    const res = await fetch(url, { headers: { 'User-Agent':'India-Trip-Map/1.0' } });
    const arr = await res.json();
    return arr && arr[0] && arr[0].geojson ? arr[0].geojson : null;
  }
  async function shadeState(stateName){
    if(!stateName || stateShadeCache.has(stateName)) return;
    const gj = await fetchStatePolygon(stateName);
    if(!gj) return;
    const layer = L.geoJSON(gj, { style: { color:'#f8bbd0', weight:1, fillColor:'#fde4ef', fillOpacity:0.32 } }).addTo(map);
    stateShadeCache.set(stateName, layer);
  }

  function emojiFor(status){ return status==='visited'?'üìç':status==='lite'?'‚úàÔ∏è':status==='stayed'?'üè°':'üìç'; }

  function makeEmojiMarker(lat, lng, status) {
    return L.marker([lat, lng], {
      icon: L.divIcon({ className:'', html:`<div style="font-size:22px">${emojiFor(status)}</div>`, iconSize:[22,22], iconAnchor:[11,11] })
    });
  }

  function render(){
    layerGroup.clearLayers();
    const list = document.getElementById('list');
    const filter = document.getElementById('filterInput').value.trim().toLowerCase();
    list.innerHTML = '';
    let shown = 0;
    places.forEach((p, idx)=>{
      const text = `${p.name||''} ${p.notes||''}`.toLowerCase();
      if(filter && !text.includes(filter)) return;
      const m = makeEmojiMarker(p.lat,p.lng,p.status).addTo(layerGroup);
      m.bindPopup(`<b>${p.name||'Place'}</b><br>${p.status==='visited'?'Visited üìç':p.status==='lite'?'Visited (Lite) ‚úàÔ∏è':'Stayed üè°'}`);
      const row = document.createElement('div'); row.className='place';
      row.innerHTML = `<div class="emoji">${emojiFor(p.status)}</div>
        <div class="meta"><div class="name">${p.name||'Place'}</div><div class="notes small">${p.state||''}</div></div>
        <div class="actions"><button data-i="${idx}" class="zoomBtn">Zoom</button><button data-i="${idx}" class="delBtn">Del</button></div>`;
      list.appendChild(row); shown++;
    });
    document.getElementById('count').textContent = `${shown}/${places.length}`;
  }

  // Load existing from local storage (you can paste your saved JSON too)
  places = load(); render();

  // Add via search
  document.getElementById('addBtn').addEventListener('click', geocodeAdd);
  document.getElementById('placeInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); geocodeAdd(); }});
  async function geocodeAdd(){
    const q = document.getElementById('placeInput').value.trim();
    if(!q) return;
    const status = document.getElementById('statusSel').value;
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&countrycodes=in`;
    const r = await fetch(url, { headers: { 'Accept-Language': 'en' }});
    const js = await r.json();
    if(!js || !js.length){ alert('Place not found. Try city + state.'); return; }
    const { lat, lon, display_name } = js[0];
    const state = await fetchStateForPoint(+lat,+lon);
    places.push({ name: display_name.split(',')[0], lat:+lat, lng:+lon, status, state: state||'', date:'', notes:'' });
    save(); render(); shadeState(state);
    document.getElementById('placeInput').value='';
  }

  // Click to add
  map.on('click', async (e)=>{
    const status = document.getElementById('statusSel').value;
    const state = await fetchStateForPoint(e.latlng.lat, e.latlng.lng);
    places.push({ name:'', lat:e.latlng.lat, lng:e.latlng.lng, status, state: state||'', date:'', notes:'' });
    save(); render(); shadeState(state);
  });

  // List actions
  document.getElementById('list').addEventListener('click', (e)=>{
    const z = e.target.closest('.zoomBtn');
    const d = e.target.closest('.delBtn');
    if(z){ const i = +z.getAttribute('data-i'); const p = places[i]; map.setView([p.lat,p.lng], 12); }
    if(d){ const i = +d.getAttribute('data-i'); places.splice(i,1); save(); render(); }
  });

  // Export JSON for public viewer
  document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
    const data = JSON.stringify(places, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'places.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  // Export backup admin.html
  document.getElementById('exportFullBtn').addEventListener('click', ()=>{
    fetch(location.href).then(r=>r.text()).then(txt=>{
      const blob = new Blob([txt], {type:'text/html'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'admin.html'; a.click(); URL.revokeObjectURL(a.href);
    });
  });
</script>
</body>
</html>
